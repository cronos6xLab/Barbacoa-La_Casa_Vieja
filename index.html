<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barbacoa de la Casa Vieja - Menú</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;500;700&family=Playfair+Display:wght@600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #8B4513;
            --primary-dark: #5D2E0C;
            --accent: #E67E22;
            --bg-body: #FAFAF8;
            --bg-card: #FFFFFF;
            --text-main: #2D2420;
            --text-light: #7D7D7D;
            --border-radius: 16px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 48px rgba(139, 69, 19, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'DM Sans', sans-serif;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; /* Evita scroll horizontal */
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* HEADER */
        header {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://i.ibb.co/mVb7xS8L/Photoroom-20251218-183639.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 30px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-img {
            height: 80px;
            width: auto;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.8);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: white;
        }

        .logo-text {
            font-size: 2rem;
            letter-spacing: -0.5px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* INFO RESTAURANTE */
        .restaurant-info {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin: -30px auto 40px;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 101;
            text-align: center;
            max-width: 1000px;
        }

        .restaurant-info h3 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        /* LAYOUT PRINCIPAL */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
            margin-bottom: 60px;
        }

        .menu-section, .cart-section, .checkout-form {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .section-title {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 15px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: var(--accent);
        }

        /* CATEGORÍAS */
        .menu-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto; /* Scroll horizontal si es necesario */
            padding-bottom: 10px;
        }

        .category-btn {
            padding: 8px 20px;
            background-color: transparent;
            border: 2px solid #E0E0E0;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .category-btn:hover, .category-btn.active {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
        }

        /* PRODUCTOS */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
            border: 1px solid rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .product-img {
            height: 180px;
            width: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--text-main);
        }

        .product-desc {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 15px;
            flex-grow: 1;
            line-height: 1.4;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .add-to-cart {
            background-color: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 6px 14px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
        }

        .add-to-cart:hover {
            background-color: var(--primary);
            color: white;
        }

        /* CARRITO LATERAL */
        .cart-section {
            position: sticky;
            top: 110px;
            height: fit-content;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item h4 { font-size: 0.9rem; }
        .cart-item-qty { width: 35px; text-align: center; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        
        .remove-item {
            background: #ffebee;
            color: #d32f2f;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        /* MAPA Y FORMULARIOS */
        .mapbox-container {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            height: 300px; /* Altura del contenedor */
            position: relative;
            display: none;
        }

        .mapbox-container.active { display: block; }

        /* --- CORRECCIÓN CRUCIAL PARA QUE SE VEA EL MAPA --- */
        #map {
            width: 100%;
            height: 100%; /* El mapa debe llenar el contenedor */
            position: absolute;
            top: 0;
            left: 0;
        }

        .map-address-search {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }

        #mapSearch {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #mapSearchBtn {
            padding: 0 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* BOTONES */
        .checkout-btn, .submit-order-btn {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
        }

        .checkout-btn { background-color: var(--accent); }
        .submit-order-btn { background-color: #25D366; }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 5px;
            font-size: 1rem;
        }

        .form-group { margin-bottom: 15px; }

        /* FLOATING ICON */
        .floating-cart-icon {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 999;
            display: none; /* Oculto en PC, visible en móvil */
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }

        .cart-count {
            position: absolute;
            top: -5px; right: -5px;
            background: var(--accent);
            width: 24px; height: 24px;
            border-radius: 50%;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* NOTIFICACIÓN TOAST */
        .notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: max-content;
            max-width: 90%;
            text-align: center;
        }

        /* FOOTER */
        footer {
            background-color: #2D2420;
            color: rgba(255,255,255,0.7);
            padding: 40px 0 20px;
            margin-top: 50px;
            text-align: center;
        }
        
        .footer-logo { height: 60px; width: auto; border-radius: 50%; margin-bottom: 15px; }

        /* =========================================
           RESPONSIVIDAD (MEDIA QUERIES)
           ========================================= */
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr; /* Una sola columna */
            }
            
            .cart-section {
                order: 2; /* El carrito va al final en tablets */
            }
        }

        @media (max-width: 768px) {
            .container { padding: 0 16px; }

            header { padding: 20px 0; }
            .header-content { flex-direction: column; text-align: center; }
            .logo-container { flex-direction: column; gap: 10px; }
            .logo-img { height: 60px; width: 60px; }
            .logo-text { font-size: 1.6rem; }

            .restaurant-info { padding: 20px; margin-top: -20px; }
            .restaurant-info h3 { font-size: 1.4rem; }
            
            /* Ajuste de Grid para móviles: 2 columnas pequeñas en vez de 1 gigante */
            .products-grid {
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px;
            }
            
            .product-card { border-radius: 12px; }
            .product-img { height: 130px; }
            .product-info { padding: 12px; }
            .product-title { font-size: 0.95rem; font-weight: 700; line-height: 1.2; }
            .product-desc { display: none; /* Ocultar descripción en móvil para ahorrar espacio */ }
            .product-price { font-size: 1rem; }
            .add-to-cart { padding: 5px 10px; font-size: 0.9rem; }

            .floating-cart-icon { display: flex; } /* Mostrar botón flotante */
            
            .modal-content { width: 90%; padding: 20px; }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr 1fr; /* Forzar 2 columnas */
            }
            .section-title { font-size: 1.3rem; }
            
            /* Ajustes finos para pantallas muy angostas */
            .category-btn { padding: 6px 14px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div class="floating-cart-icon" id="floatingCartIcon">
        <i class="fas fa-shopping-bag"></i> 
        <div class="cart-count" id="floatingCartCount">0</div>
    </div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://i.ibb.co/jkWp21kD/IMG-4398.jpg" alt="Logo Barbacoa" class="logo-img">
                    <h1 class="logo-text">Barbacoa Casa Vieja</h1>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="restaurant-info">
            <h3><i class="fas fa-fire-burner"></i> Tradición desde 1989</h3>
            <p style="font-size: 0.9rem; color: #666;">Sábados y Domingos 8:00 AM - 2:00 PM</p>
            <p style="font-size: 0.9rem;"><i class="fas fa-map-pin" style="color:var(--accent)"></i> Claveria, Azcapotzalco</p>
        </div>
        
        <div class="main-content">
            <section class="menu-section">
                <h2 class="section-title">Menú</h2>
                
                <div class="menu-categories">
                    <button class="category-btn active" data-category="all">Todo</button>
                    <button class="category-btn" data-category="barbacoa">Barbacoa</button>
                    <button class="category-btn" data-category="bebidas">Bebidas</button>
                    <button class="category-btn" data-category="postres">Postres</button>
                </div>

                <div class="products-grid" id="productsGrid">
                    </div>
            </section>

            <section class="cart-section" id="cartSection">
                <h2 class="section-title">Tu Pedido</h2>
                
                <div class="cart-items" id="cartItems">
                    <p style="text-align:center; color:#999; margin-top:20px;">Tu canasta está vacía</p>
                </div>

                <div style="background:#f4f4f4; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Subtotal:</span>
                        <span id="subtotal" style="font-weight:bold;">$0.00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Envío:</span>
                        <span id="shippingCost">$0.00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:1.2rem; color:var(--primary); border-top:1px dashed #ccc; padding-top:10px; margin-top:5px;">
                        <span>Total:</span>
                        <span id="total" style="font-weight:800;">$0.00</span>
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; background:white; padding:10px; border:1px solid #eee; border-radius:8px;">
                        <input type="radio" name="deliveryType" value="pickup" checked>
                        <span><i class="fas fa-store"></i> Pasar a recoger</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; background:white; padding:10px; border:1px solid #eee; border-radius:8px;">
                        <input type="radio" name="deliveryType" value="delivery">
                        <span><i class="fas fa-motorcycle"></i> Envío a domicilio</span>
                    </label>
                </div>

                <div id="deliveryAddressSection" style="display: none;">
                    <button id="useCurrentLocationBtn" style="width:100%; padding:10px; background:#e3f2fd; color:#1565c0; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-bottom:10px;">
                        <i class="fas fa-location-arrow"></i> Usar mi ubicación
                    </button>

                    <div class="mapbox-container" id="mapboxContainer">
                        <div class="map-address-search">
                            <input type="text" id="mapSearch" placeholder="Buscar calle...">
                            <button id="mapSearchBtn"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="map"></div> </div>
                    
                    <input type="text" id="deliveryAddress" class="form-control" placeholder="Dirección exacta (calle, número)" style="margin-top:10px;">
                    
                    <button id="calculateShippingBtn" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">
                        Calcular Envío
                    </button>
                    
                    <div id="distanceDetails" style="display:none; text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">
                        Distancia: <span id="distanceText">--</span>
                    </div>
                </div>

                <button class="checkout-btn" id="checkoutBtn">Pagar <i class="fas fa-arrow-right"></i></button>
            </section>
        </div>

        <section class="checkout-form" id="checkoutForm" style="display: none; max-width: 600px; margin: 0 auto;">
            <h2 class="section-title">Finalizar</h2>
            <form id="orderForm">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="customerName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="tel" id="customerPhone" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Método de Pago</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; text-align:center;">
                            <input type="radio" name="paymentMethod" value="cash" id="cashOption"> Efectivo
                        </label>
                        <label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; text-align:center;">
                            <input type="radio" name="paymentMethod" value="card" checked> Tarjeta
                        </label>
                    </div>
                    
                    <div id="cashInputGroup" style="display:none; margin-top:10px;">
                        <label>¿Con cuánto pagas?</label>
                        <input type="number" id="cashAmount" class="form-control" placeholder="$0.00">
                        <small id="changeText" style="color:var(--primary); font-weight:bold;"></small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="customerNotes" class="form-control" rows="2"></textarea>
                </div>

                <button type="submit" class="submit-order-btn"><i class="fab fa-whatsapp"></i> Enviar Pedido</button>
                <button type="button" id="cancelCheckout" style="width:100%; padding:10px; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">Cancelar</button>
            </form>
        </section>
    </div>

    <div class="notification" id="notification">Mensaje aquí</div>

    <footer>
        <div class="container">
            <img src="https://i.ibb.co/jkWp21kD/IMG-4398.jpg" alt="Logo Footer" class="footer-logo">
            <p>&copy; 2025 Barbacoa de la Casa Vieja</p>
        </div>
    </footer>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <script>
        /* ================= CONFIGURACIÓN ================= */
        const whatsappNumber = "525578677774"; // Número destino
        const restaurantCoords = [-99.1853, 19.4646]; // Coordenadas local
        const mapboxToken = 'pk.eyJ1IjoiY3Jvbm9zYmFyYmFjb2EiLCJhIjoiY21qYXlzN2EzMGEwcTNkcTF3c2w2YWc2bCJ9.dKvmIuJz1h-loUcVlx5Ojw';
        
        // Productos (JSON Simple)
        const products = [
            { id: 1, name: "1 Kg Barbacoa", price: 780, cat: "barbacoa", img: "https://i.ibb.co/8nq6VhpF/IMG-4420.jpg", desc: "Incluye tortillas y salsas" },
            { id: 2, name: "1/2 Kg Barbacoa", price: 390, cat: "barbacoa", img: "https://i.ibb.co/fYGGQmbQ/IMG-4423.jpg", desc: "Media porción deliciosa" },
            { id: 3, name: "1/4 Kg Barbacoa", price: 195, cat: "barbacoa", img: "https://i.ibb.co/21HD2W3h/IMG-4428.png", desc: "Ideal para 1 persona" },
            { id: 4, name: "Consomé (Litro)", price: 90, cat: "barbacoa", img: "https://i.ibb.co/sdFbnRs0/IMG-4490.jpg", desc: "Con arroz y garbanzo" },
            { id: 5, name: "Flautas (3 pzas)", price: 140, cat: "barbacoa", img: "https://images.unsplash.com/photo-1563379926898-05f4575a45d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", desc: "Con crema y queso" },
            { id: 6, name: "Café de Olla", price: 38, cat: "bebidas", img: "https://i.ibb.co/Kcm8QRb1/IMG-4614.png", desc: "Tradicional" },
            { id: 7, name: "Flan Casero", price: 35, cat: "postres", img: "https://i.ibb.co/Kx9J9yQD/IMG-4615.png", desc: "De la casa" }
        ];

        /* ================= LÓGICA ================= */
        let cart = [];
        let map, deliveryMarker;
        let shippingCost = 0;
        let deliveryDistance = 0;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            mapboxgl.accessToken = mapboxToken;
            renderProducts('all');
            
            // Eventos Categorías
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderProducts(e.target.dataset.category);
                });
            });

            // Toggle Entrega
            document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isDelivery = e.target.value === 'delivery';
                    document.getElementById('deliveryAddressSection').style.display = isDelivery ? 'block' : 'none';
                    document.getElementById('mapboxContainer').classList.toggle('active', isDelivery);
                    
                    shippingCost = 0;
                    updateCartUI();

                    if (isDelivery && !map) {
                        initMap(); // Iniciar mapa solo si se selecciona envío
                    } else if (isDelivery && map) {
                        setTimeout(() => map.resize(), 100); // REPARACIÓN IMPORTANTE
                    }
                });
            });

            // Lógica de Pago Efectivo
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('cashInputGroup').style.display = e.target.value === 'cash' ? 'block' : 'none';
                });
            });

            document.getElementById('cashAmount').addEventListener('input', (e) => {
                const total = getCartTotal();
                const pay = parseFloat(e.target.value) || 0;
                const change = pay - total;
                document.getElementById('changeText').textContent = change >= 0 ? `Cambio: $${change.toFixed(2)}` : 'Monto insuficiente';
            });
            
            // Botón Checkout
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if(cart.length === 0) return showToast("El carrito está vacío");
                document.getElementById('checkoutForm').style.display = 'block';
                document.getElementById('checkoutForm').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('cancelCheckout').addEventListener('click', () => {
                document.getElementById('checkoutForm').style.display = 'none';
            });

            // Botón Flotante
            document.getElementById('floatingCartIcon').addEventListener('click', () => {
                document.getElementById('cartSection').scrollIntoView({ behavior: 'smooth' });
            });

            // Formulario Final
            document.getElementById('orderForm').addEventListener('submit', (e) => {
                e.preventDefault();
                sendWhatsApp();
            });

            // Mapa Search
            document.getElementById('mapSearchBtn').addEventListener('click', searchAddress);
            document.getElementById('calculateShippingBtn').addEventListener('click', calculateRoute);
            document.getElementById('useCurrentLocationBtn').addEventListener('click', getGeoLocation);
        });

        /* ================= FUNCIONES ================= */
        
        function renderProducts(cat) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            const filtered = cat === 'all' ? products : products.filter(p => p.cat === cat);
            
            filtered.forEach(p => {
                grid.innerHTML += `
                    <div class="product-card">
                        <img src="${p.img}" class="product-img" alt="${p.name}">
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-desc">${p.desc}</p>
                            <div class="product-footer">
                                <div class="product-price">$${p.price}</div>
                                <button class="add-to-cart" onclick="addToCart(${p.id})">Agregar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            const p = products.find(i => i.id === id);
            const exist = cart.find(i => i.id === id);
            if(exist) exist.qty++;
            else cart.push({ ...p, qty: 1 });
            updateCartUI();
            showToast(`${p.name} agregado`);
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCartUI();
        }

        function updateCartUI() {
            const container = document.getElementById('cartItems');
            const subtotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            const total = subtotal + shippingCost;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('shippingCost').textContent = `$${shippingCost.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            document.getElementById('floatingCartCount').textContent = cart.reduce((acc,i)=>acc+i.qty,0);

            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">Carrito vacío</p>';
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <h4>${item.name}</h4>
                        <small>$${item.price} x ${item.qty}</small>
                    </div>
                    <button class="remove-item" onclick="removeFromCart(${item.id})"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function getCartTotal() {
            return cart.reduce((acc, i) => acc + (i.price * i.qty), 0) + shippingCost;
        }

        function showToast(msg) {
            const t = document.getElementById('notification');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        /* ================= MAPBOX ================= */
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: restaurantCoords,
                zoom: 13
            });

            // Marcador Restaurante
            new mapboxgl.Marker({ color: '#8B4513' }).setLngLat(restaurantCoords).addTo(map);

            map.on('click', (e) => {
                setDeliveryPoint(e.lngLat);
            });
        }

        function setDeliveryPoint(lngLat) {
            if(deliveryMarker) deliveryMarker.remove();
            deliveryMarker = new mapboxgl.Marker({ color: '#E67E22' }).setLngLat(lngLat).addTo(map);
        }

        function searchAddress() {
            const query = document.getElementById('mapSearch').value;
            if(!query) return;
            
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?access_token=${mapboxToken}&bbox=-99.3,19.3,-99.0,19.6&limit=1`)
                .then(res => res.json())
                .then(data => {
                    if(data.features.length) {
                        const center = data.features[0].center;
                        map.flyTo({ center: center, zoom: 15 });
                        setDeliveryPoint(center);
                        document.getElementById('deliveryAddress').value = data.features[0].place_name;
                    } else {
                        showToast("Dirección no encontrada");
                    }
                });
        }

        function getGeoLocation() {
            if(!navigator.geolocation) return showToast("Geolocalización no soportada");
            navigator.geolocation.getCurrentPosition(pos => {
                const coords = [pos.coords.longitude, pos.coords.latitude];
                map.flyTo({ center: coords, zoom: 15 });
                setDeliveryPoint(coords);
                
                // Reverse Geocode para llenar el input
                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${mapboxToken}`)
                .then(res => res.json())
                .then(data => {
                    if(data.features.length) document.getElementById('deliveryAddress').value = data.features[0].place_name;
                });
            });
        }

        function calculateRoute() {
            if(!deliveryMarker) return showToast("Selecciona un punto en el mapa");
            
            const dest = deliveryMarker.getLngLat();
            // Calcular distancia en línea recta simple para demo (Mapbox directions API requiere más config a veces)
            // Usamos fórmula Haversine simplificada
            const R = 6371; 
            const dLat = (dest.lat - restaurantCoords[1]) * Math.PI / 180;
            const dLon = (dest.lng - restaurantCoords[0]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(restaurantCoords[1] * Math.PI / 180) * Math.cos(dest.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            deliveryDistance = (R * c).toFixed(2);
            
            // Costo: $10 por km
            shippingCost = Math.ceil(deliveryDistance * 10);
            if(shippingCost < 20) shippingCost = 20; // Mínimo
            
            document.getElementById('distanceText').textContent = `${deliveryDistance} km`;
            updateCartUI();
            showToast(`Envío calculado: $${shippingCost}`);
        }

        /* ================= WHATSAPP ================= */
        function sendWhatsApp() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const notes = document.getElementById('customerNotes').value;
            const type = document.querySelector('input[name="deliveryType"]:checked').value;
            const payMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            let text = `Hola! Soy *${name}*, quiero hacer un pedido:%0A%0A`;
            
            cart.forEach(item => {
                text += `▪ ${item.qty}x ${item.name} ($${item.price})%0A`;
            });

            text += `%0A*Subtotal:* $${(getCartTotal() - shippingCost).toFixed(2)}`;
            
            if(type === 'delivery') {
                const address = document.getElementById('deliveryAddress').value;
                text += `%0A*Envío:* $${shippingCost} (Distancia: ${deliveryDistance}km)`;
                text += `%0A*Dirección:* ${address}`;
            } else {
                text += `%0A*Entrega:* Recoger en tienda`;
            }

            text += `%0A*TOTAL:* $${getCartTotal().toFixed(2)}`;
            text += `%0A*Pago:* ${payMethod === 'cash' ? 'Efectivo' : 'Tarjeta'}`;
            
            if(payMethod === 'cash') {
                const amount = document.getElementById('cashAmount').value;
                text += ` (Pago con $${amount})`;
            }

            if(notes) text += `%0A*Notas:* ${notes}`;

            window.open(`https://wa.me/${whatsappNumber}?text=${text}`, '_blank');
        }
    </script>
</body>
</html>
